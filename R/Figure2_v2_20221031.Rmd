---
title: "Figure2_20220318"
output:
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Figure 2

required libraries

```{r, echo=FALSE}
library(edgeR)
library(SummarizedExperiment)
library(SEtools)
library(plgINS)
library(ggplot2)
library(DESeq2)
library(sva)
library(cowplot)
library(xlsx)
library(sechm)
source("BioStatsfunctions_LvZ.R")
set.seed(123)
sessionInfo()
```

Load data

```{r}
opto_vHC <- readRDS("../data/OptoTranscriptomics_Seq1Only.vHC.SE.rds")
opto_dHC <- readRDS("../data/OptoTranscriptomics_Seq1Only.dHC.SE.rds")
DREADD_vHC <- readRDS("../data/DREADDTranscriptomics.vHC.SE.rds")
DREADD_dHC <- readRDS("../data/DREADDTranscriptomics.dHC.SE.rds")
retro_opto <- readRDS("../data/OPTO9.SE.Rds")


DREADD <- cbind(DREADD_vHC[intersect(rownames(DREADD_vHC),rownames(DREADD_dHC)),],DREADD_dHC[intersect(rownames(DREADD_vHC),rownames(DREADD_dHC)),])
DREADD <- dosvacor(DREADD, form = ~Virus + Region, form0 = ~Region)
DREADD <- DREADD[,order(DREADD$Region,DREADD$Virus)]

opto <- cbind(opto_vHC[intersect(rownames(opto_vHC),rownames(opto_dHC)),],opto_dHC[intersect(rownames(opto_vHC),rownames(opto_dHC)),])
opto <- dosvacor(opto, form = ~Condition2 + Region, form0 = ~Region)
opto <- opto[,order(opto$Region,opto$TimePoint,opto$Virus)]

mincount <- 30
Results <- list()
```


## DREADD Volcanos (Fig2B)

Volcanoplots that show the significant genes upon chemogenetic activation of LC

```{r}
DREADD_vHC <- dosvacor(DREADD_vHC, form = ~Virus)
DREADD_dHC <- dosvacor(DREADD_dHC, form = ~Virus)

y <- DGEList(counts=assays(DREADD_vHC)$counts,group = DREADD_vHC$Virus)
y <- calcNormFactors(y)
y <- estimateDisp(y)
y <- y[filterByExpr(y,group = DREADD_vHC$Virus, min.count = mincount),]
Results[["DREADD_vHC"]] <- exactTest(y)

y <- DGEList(counts=assays(DREADD_dHC)$counts,group = DREADD_dHC$Virus)
y <- calcNormFactors(y)
y <- estimateDisp(y)
y <- y[filterByExpr(y,group = DREADD_dHC$Virus, min.count = mincount),]
Results[["DREADD_dHC"]] <- exactTest(y)

sig_DREADD_vHC <- rownames(topTags(Results[["DREADD_vHC"]], n = Inf, p.value = 0.05))
sig_DREADD_dHC <- rownames(topTags(Results[["DREADD_dHC"]], n = Inf, p.value = 0.05))

Fig2B <- VolcanoPlotsEdgeR(Results[c("DREADD_vHC","DREADD_dHC")],limits = c(-2,2), lab = union(sig_DREADD_vHC,sig_DREADD_dHC))
```



## Figure 2H opto Volcanos (Fig2H)

Volcanoplots that show the significant genes upon optogenetic activation of LC at 45min and 90min (vHC only)


```{r}
opto_vHC <- dosvacor(opto_vHC, form = ~Condition2)
opto_dHC <- dosvacor(opto_dHC, form = ~Condition2)

opto_vHC_45min <- opto_vHC[,opto_vHC$TimePoint == "45min"]
opto_vHC_90min <- opto_vHC[,opto_vHC$TimePoint == "1h30min"]

y <- DGEList(counts=assays(opto_vHC_45min)$counts,group = opto_vHC_45min$Virus)
y <- calcNormFactors(y)
y <- estimateDisp(y)
y <- y[filterByExpr(y,group = opto_vHC_45min$Virus, min.count = mincount),]
Results[["opto_vHC_45min"]] <- exactTest(y)

y <- DGEList(counts=assays(opto_vHC_90min)$counts,group = opto_vHC_90min$Virus)
y <- calcNormFactors(y)
y <- estimateDisp(y)
y <- y[filterByExpr(y,group = opto_vHC_90min$Virus, min.count = mincount),]
Results[["opto_vHC_1h30min"]] <- exactTest(y)


opto_dHC_45min <- opto_dHC[,opto_dHC$TimePoint == "45min"]
opto_dHC_90min <- opto_dHC[,opto_dHC$TimePoint == "1h30min"]

y <- DGEList(counts=assays(opto_dHC_45min)$counts,group = opto_dHC_45min$Virus)
y <- calcNormFactors(y)
y <- estimateDisp(y)
y <- y[filterByExpr(y,group = opto_dHC_45min$Virus, min.count = mincount),]
Results[["opto_dHC_45min"]] <- exactTest(y)

y <- DGEList(counts=assays(opto_dHC_90min)$counts,group = opto_dHC_90min$Virus)
y <- calcNormFactors(y)
y <- estimateDisp(y)
y <- y[filterByExpr(y,group = opto_dHC_90min$Virus, min.count = mincount),]
Results[["opto_dHC_1h30min"]] <- exactTest(y)


sig_opto_vHC_45min <- rownames(topTags(Results[["opto_vHC_45min"]], n = Inf, p.value = 0.05))
sig_opto_vHC_90min <- rownames(topTags(Results[["opto_vHC_1h30min"]], n = Inf, p.value = 0.05))

Fig2H <- VolcanoPlotsEdgeR(Results[c("opto_vHC_45min","opto_vHC_1h30min")], lab = union(sig_opto_vHC_45min,sig_opto_vHC_90min))
```


## Aggregate across Yohimnbine, DREADD and Opto Heatmap (Fig2N)

The following plot will highlight NA responsive genes across three experiments. heatmap shows results when combining all 3 datasets and fitting a one-way anova type of model. this detects genes that are variable across these three experimental conditions (though the effect strength can be different between experiments)

```{r}
#Overlap significant
STR2 <- readRDS("../final_data/STR2_Complete.SE.Rds")

YohvHC <- na.omit(rowData(STR2)$DEA.vHC_CtrlvsYohimb)
YohdHC <- na.omit(rowData(STR2)$DEA.dHC_CtrlvsYohimb)

Yoh_sig <- union(rownames(YohvHC[YohvHC$FDR < 0.05,]), rownames(YohdHC[YohdHC$FDR < 0.05,]))
DREADD_sig <- union(rownames(topTags(Results$DREADD_vHC, n = Inf, p = 0.05)), rownames(topTags(Results$DREADD_dHC, n = Inf, p = 0.05)))
opto_sig <- rownames(topTags(Results$opto_vHC_45min, n = Inf, p.value = 0.05))

x <- list(Yoh = Yoh_sig, DREADD = DREADD_sig, Opto = opto_sig)

ggvenn::ggvenn(x)

#Overlap top 100
x <- list(Yoh = rownames(YohvHC[order(YohvHC$PValue),][1:100,]), 
          DREADD = rownames(topTags(Results$DREADD_vHC,n = 100)), 
          Opto = rownames(topTags(Results$opto_vHC_45min,n = 100)))
ggvenn::ggvenn(x)

```

## Genes with similar effect NA response across all three experiments (Fig2P)

In this analysis the three experiments (yoh, opto and dreadd) are combined again, however this time we consider the "stimulation" to be of the same type, i.e we combine all test groups and run a statistical test for it. this type of analysis will be sensitive to genes that respond very consistently to NA stimulation across all three experiments

```{r}



#Option A, statistical method, all combined

Yoh <- STR2[,STR2$Condition2 %in% c("Saline-Ctrl","Saline-Yohimbine")]
Yoh$Condition3 <- ifelse(Yoh$Condition == "Homecage","Control","Test")
Yoh <- Yoh[,Yoh$Region == "vHC"]
DREADD2 <- DREADD[,DREADD$Region == "vHC"]
DREADD2$Condition3 <- ifelse(DREADD2$Virus == "Control","Control","Test")
opto_vHC_45min$Condition3 <- ifelse(opto_vHC_45min$Virus == "Control","Control","Test")

m <- mergeSEs(ll = list(Yohimbne = Yoh, DREADD = DREADD2, Opto = opto_vHC_45min),commonOnly =TRUE,keepRowData = FALSE,do.scale = FALSE,use.assays = "counts")
m$Condition3 <- as.factor(m$Condition3)
m$Experiment <- as.factor(m$Experiment)

m <- dosvacor(m, form = ~Experiment + Condition3, form0 = ~Experiment)

m_design <- model.matrix(~m$Condition3 + m$Experiment)

y <- DGEList(counts=assays(m)$counts)
y <- calcNormFactors(y)
y <- estimateDisp(y,m_design)
#filter out genes that are low expressed
y <- y[filterByExpr(y, m_design, min.count = mincount),]
m_fit <- glmQLFit(y,m_design)

res <- glmQLFTest(m_fit, colnames(m_design)[2])

m <- m[,order(m$Condition3)]
Fig2P <- sechm(m,
      rownames(topTags(res,n = Inf, p.value = 0.05)),
      assayName = "corrected",
      do.scale = T, 
      top_annotation = c("Experiment","Condition3"),
      gaps_at = c("Experiment"))
Fig2P

```


## Aggregate across datasets (FigS2X and FigS2X2)

Here we do the following to detect genes that are responsive across datasets:
we see which position (by significane) a gene is in a given analysis (1st, 2nd, 3rd etc)
we then sum up all these positions across the relevant analyses
this gives us a ranking of genes by NA responsiveness

```{r}
Results2 <- readRDS("Results_stats.Rds")

datasets <- c("STR2v_StressvsPropr","STR2d_StressvsPropr","STR3_InteractionPropranolol","DREADD_vHC","DREADD_dHC","opto_vHC_45min")

#Create pvalue data frame across the selected analyses
pvals <- data.frame(Results2[[datasets[1]]]$table[,"PValue"])
rownames(pvals) <- rownames(Results2[[datasets[1]]]$table)
pvals$gene <- rownames(pvals)
for(i in datasets[-1]){
  targets <- intersect(rownames(pvals),rownames(Results2[[i]]$table))
  pvals <- pvals[targets,]
  pvals <- cbind(pvals,Results2[[i]]$table[targets,"PValue"])
}

pvals <- na.omit(pvals)
pvals$gene <- NULL

#get order of each gene in each dataset based on pvalue
ord <- apply(pvals,MARGIN = 2, FUN = function(x){
  o <- order(x)
  r <- 1:length(x)
  return(r[order(o)])
})
rownames(ord) <- rownames(pvals)
ord <- apply(ord, MARGIN = 1, FUN = sum)

#Top 20 genes
head(ord[order(ord)],20)

#create plot of top n genes
n <- 4
n2 <- 10
t <- names(ord[order(ord)][1:n])
t2 <- names(ord[order(ord)][1:n2])

STR2 <- readRDS("../final_data/STR2_Complete.SE.Rds")
STR3 <- readRDS("../final_data/STR3_Complete.SE.Rds")
STR3 <- STR3[,STR3$Injection != "Sotalol"]

rowData(STR2) <- NULL
rowData(STR3) <- NULL

pSTR2 <- meltSE(STR2,t)
p1 <- ggplot(pSTR2,aes(Condition2, corrected, color = Condition)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitterdodge()) + 
  facet_grid(feature~Region, scales = "free") + 
  theme_bw() + theme(legend.position="bottom") + 
  ylab("relative expression") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

pSTR3 <-meltSE(STR3,t)
pSTR3 <- pSTR3[pSTR3$Injection != "Sotalol",]
p2 <- ggplot(pSTR3,aes(Injection, corrected, color = Condition)) +
  geom_boxplot(outlier.shape = NA) + geom_point(position = position_jitterdodge()) + 
  facet_grid(feature~Region, scales = "free") + 
  theme_bw()  + 
  theme(legend.position="bottom") + 
  ylab("relative expression") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

popto <- meltSE(opto_vHC,t)
popto$TimePoint <- factor(popto$TimePoint, levels = c("45min","1h30min"))
p3 <- ggplot(popto,aes(TimePoint, corrected, color = Virus)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitterdodge()) + 
  facet_grid(feature~Region, scales = "free") + 
  theme_bw()  + theme(legend.position="bottom") + 
  ylab("relative expression")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

pDREADD <- meltSE(DREADD,t)
p4 <- ggplot(pDREADD,aes(Virus, corrected, color = Virus)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitterdodge()) + 
  facet_grid(feature~Region, scales = "free") + 
  theme_bw()  + theme(legend.position="bottom") + 
  ylab("relative expression")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

FigS2X <- plot_grid(p1,p2,p3,p4,nrow = 1,rel_widths = c(1,0.6,0.6,0.7))
FigS2X

#plot genes by log rank

df_NAgenes <- data.frame(rank = ord[order(ord)], index = 1:length(ord))
df_NAgenes$lab <- rep(NA,nrow(df_NAgenes))
df_NAgenes$lab[1:n] <- t
FigS2X2 <- ggplot(df_NAgenes,aes(index, log10(rank), label = lab)) + geom_point() + theme_bw() + geom_text_repel()
FigS2X2
saveRDS(df_NAgenes,"../final_data/NAgenes.Rds")
```

## NA responsive genes in retrograde opto (Fig2L, will go to Figure 3!)

Here we select the top genes from the NA responsivenes analysis and analyse only these genes in the retro opto dataset

```{r}
retro_opto_CHR2pvsn <- retro_opto[,retro_opto$Group != "HC"]
retro_opto_CHR2pvsn$Group <- droplevels(retro_opto_CHR2pvsn$Group)
retro_opto_CHR2pvsn <- dosvacor(retro_opto_CHR2pvsn, form = ~Group)

y <- DGEList(counts=assays(retro_opto_CHR2pvsn)$counts,group = retro_opto_CHR2pvsn$Group)
y <- calcNormFactors(y)
y <- estimateDisp(y)
y <- y[filterByExpr(y,group = retro_opto_CHR2pvsn$Group, min.count = mincount),]
Results[["retro_opto_CHR2pvsn"]] <- exactTest(y)

pretro_opto <- meltSE(retro_opto_CHR2pvsn,t)

stats <- Results[["retro_opto_CHR2pvsn"]]$table[t,]
stats$FDR <- p.adjust(stats$PValue, method = "fdr")

Fig2L <- ggplot(pretro_opto,aes(Group, logcpm, color = Group)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitterdodge()) + 
  facet_wrap(~feature, scales = "free", nrow = 1) + 
  theme_bw()  + theme(legend.position="bottom") + 
  ylab("logcpm")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

Fig2L
stats
```

## NA turnover (MHPG/NA) vs Dio2 expression (Fig2M)

Here we correlate the MHPG/NA vs Dio2 expression in the retro opto experiment. we run a statistical analysis for correlation one time across all samples, and one time also across the Chr2 positive virus samples only. both are significant

```{r, fig.height= 4, fig.width=6}
meta <- read.xlsx("../data/Opto9_HPLC_RH-dHC_R.xlsx",sheetIndex = 1)[1:34,]


assign <- match(colnames(retro_opto_CHR2pvsn), meta$Sample)
retro_opto_CHR2pvsn$MHPG <- meta[assign,"MHPG"]
retro_opto_CHR2pvsn$NE <- meta[assign,"NE"]
retro_opto_CHR2pvsn$ratioMHPGvNE <- retro_opto_CHR2pvsn$MHPG / retro_opto_CHR2pvsn$NE 

#linear correaltion across all samples
pdat <- meltSE(retro_opto_CHR2pvsn,"Dio2")
mod <- lm(pdat$logcpm ~ pdat$ratioMHPGvNE)
summary(mod)

#linear correaltion within the ChR2_p group only
pdat_p <- pdat[pdat$Group == "ChR2_p",]
mod <- lm(pdat_p$logcpm ~ pdat_p$ratioMHPGvNE)
summary(mod)

Fig2M <- ggplot(pdat, aes(MHPG/NE,logcpm)) + geom_point(aes(MHPG/NE,logcpm, color = Group)) + theme_bw() + geom_smooth(method = "lm", color = "black", fill = "grey80")
Fig2M
```


##  retroopto and optofmri radial plots of top genes (Fig2N will go to Figure 3!)

We visualize the response strength of the top NA genes in the retro and optofmri data and produce statistical results for these selected genes (subset for reduced multiple testing correction)

```{r}
LCopto <- readRDS("../data/LCOptoFmri.SE.rds") 
LCopto <- LCopto[,LCopto$Tissue == "R-vHC"]
LCopto <- dosvacor(LCopto,form = ~Group + Sex, form0 = ~Sex)

design <- model.matrix(~LCopto$Group + LCopto$SV1 + LCopto$SV2)

y <- DGEList(counts=assays(LCopto)$counts)
y <- calcNormFactors(y)
y <- estimateDisp(y,design)
#filter out genes that are low expressed
y <- y[filterByExpr(y, design),]

fit <- glmQLFit(y,design)

Results[["vHC.FullModel"]] <- glmQLFTest(fit, colnames(design)[2:4])
Results[["vHC.FullModel"]]$table$meanLogFC <- apply(Results[["vHC.FullModel"]]$table,1,FUN = function(x){mean(x[1:3])})
Results[["vHC.FullModel"]]$table$logFC <- apply(Results[["vHC.FullModel"]]$table,1,FUN = function(x){mean(x[1:3])})
Results[["vHC.3Hz"]] <- glmQLFTest(fit, colnames(design)[2])
Results[["vHC.5Hz"]] <- glmQLFTest(fit, colnames(design)[3])
Results[["vHC.15Hz"]] <- glmQLFTest(fit, colnames(design)[4])

stats <- Results[["retro_opto_CHR2pvsn"]]$table[t2,]
stats$FDR <- p.adjust(stats$PValue, method = "fdr")

pdat <- data.frame(gene = t2,
                   logFC.vHC.retro =   Results[["retro_opto_CHR2pvsn"]]$table[t2,"logFC"],
                   logFC.vHC3Hz = Results[["vHC.FullModel"]]$table[t2,"logFC.LCopto.Group3Hz"],
                   logFC.vHC5Hz = Results[["vHC.FullModel"]]$table[t2,"logFC.LCopto.Group5Hz"],
                   logFC.vHC15Hz = Results[["vHC.FullModel"]]$table[t2,"logFC.LCopto.Group15Hz"])

pdat$index <- NULL
pdat[,c("logFC")] <- NULL
radial.df <- tidyr::pivot_longer(pdat,cols = -1)
radial.df$direction = ifelse(radial.df$value >= 0, "up-regulated", "down-regulated")
radial.df$value <- abs(radial.df$value)

radial.df$name <- factor(radial.df$name, levels = c("logFC.vHC.retro","logFC.vHC3Hz","logFC.vHC5Hz","logFC.vHC15Hz"))

Fig2Q <- ggplot(radial.df, aes(x=gene, y=sqrt(value), fill=gene, color = direction)) +
    geom_bar(stat='identity') + facet_wrap(~name, nrow = 1) + coord_polar() + scale_color_manual(values= c("red","black")) + theme_bw() + ggtitle("top 10 NA genes in vHC and dHC using different stimulation frequencies")

#stats, different stimulations
topTags(Results[["vHC.FullModel"]][t2,])
```

## Show Final Figures

```{r, fig.height= 4, fig.width=6}
print(Fig2B)
```

```{r, fig.height= 4, fig.width=6}
print(Fig2H)
```

```{r, fig.height= 3, fig.width=6}
print(Fig2L)
```

```{r, fig.height= 3, fig.width=4}
print(Fig2M)
```

```{r, fig.height= 4, fig.width=6}
print(Fig2P)
```


```{r, fig.height= 6, fig.width=8}
print(Fig2Q)
```

```{r, fig.height= 4, fig.width=4}
print(FigS2X2)
```

## Export Figures

```{r}
pdf(file = "../Figures/Fig2B.pdf", width = 6, height = 4)
print(Fig2B)
dev.off()

pdf(file = "../Figures/Fig2H.pdf", width = 6, height = 4)
print(Fig2H)
dev.off()

pdf(file = "../Figures/Fig2L.pdf", width = 6, height = 3)
print(Fig2L)
dev.off()

pdf(file = "../Figures/Fig2M.pdf", width = 4, height = 3)
print(Fig2M)
dev.off()

pdf(file = "../Figures/Fig2Q.pdf", width = 6, height = 8)
print(Fig2Q)
dev.off()

pdf(file = "../Figures/FigS2X.pdf", width = 10, height = 8)
print(FigS2X)
dev.off()

pdf(file = "../Figures/FigS2X2.pdf", width = 4, height = 4)
print(FigS2X2)
dev.off()


```


## Create final data frames (containing corrected expression and Results data as single SE file)

```{r, eval = FALSE}

for(i in names(Results)){
  Results[[i]]$table$FDR <- p.adjust(Results[[i]]$table$PValue, method = "fdr")
}

rowData(opto_vHC)$DEA.vHC_45min <- Results$opto_vHC_45min$table[rownames(opto_vHC),]
attr(rowData(opto_vHC)$DEA.vHC_45min, "description") <- "two group analysis of ChR2 vs control virus analysis after 45min"

rowData(opto_vHC)$DEA.vHC_1h30min <- Results$opto_vHC_1h30min$table[rownames(opto_vHC),]
attr(rowData(opto_vHC)$DEA.vHC_1h30min, "description") <- "two group analysis of ChR2 vs control virus analysis after 1h30min"

metadata(opto_vHC)$default_view <- list(assay = "corrected", groupvar = "TimePoint", colvar = "Virus")
metadata(opto_vHC)$description <- "In this experiment the vHC transcriptome of animals in which LC was activated optogenetically 45min or 1h30min prior to sacrifice is tested"

saveRDS(opto_vHC, "../final_data/Opto_Complete.Rds")

rowData(DREADD)$DEA.vHC <- Results$DREADD_vHC$table[rownames(DREADD),]
attr(rowData(DREADD)$DEA.vHC, "description") <- "two group analysis of hM3Dq vs control virus analysis after 45min in vHC"

rowData(DREADD)$DEA.dHC <- Results$DREADD_dHC$table[rownames(DREADD),]
attr(rowData(DREADD)$DEA.dHC, "description") <- "two group analysis of hM3Dq vs control virus analysis after 45min in dHC"

metadata(DREADD)$default_view <- list(assay = "corrected", gridvar = "Region", groupvar = "Virus", colvar = "Virus")
metadata(DREADD)$description <- "In this experiment the vHC and dHC transcriptome of animals in which LC was activated chemogenetically 45min prior to sacrifice is tested"

saveRDS(DREADD, "../final_data/DREADD_Complete.Rds")

rowData(retro_opto_CHR2pvsn)$DEA.ChR2vsControl <- Results$retro_opto_CHR2pvsn$table[rownames(retro_opto_CHR2pvsn),]
attr(rowData(retro_opto_CHR2pvsn)$DEA.ChR2vsControl, "description") <- "two group analysis of ChR2 vs control retro virus analysis after 45min in vHC"

metadata(retro_opto_CHR2pvsn)$default_view <- list(assay = "corrected", groupvar = "Group", colvar = "Group")
metadata(retro_opto_CHR2pvsn)$description <- "In this experiment the vHC transcriptome of animals in which LC neurons that project to the hippocampus were activated optogenetically 45min prior to sacrifice is assessed"

saveRDS(retro_opto_CHR2pvsn, "../final_data/RetroOpto_Complete.Rds")

```