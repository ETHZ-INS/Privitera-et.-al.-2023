---
title: "Figure2_20220318"
output:
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Figure 2

required libraries

```{r, echo=FALSE}
library(edgeR)
library(SummarizedExperiment)
library(SEtools)
library(plgINS)
library(ggplot2)
library(DESeq2)
library(sva)
library(cowplot)
source("BioStatsfunctions_LvZ.R")
set.seed(123)
sessionInfo()
```

Load data

```{r}
opto_vHC <- readRDS("../data/OptoTranscriptomics_Seq1Only.vHC.SE.rds")
opto_dHC <- readRDS("../data/OptoTranscriptomics_Seq1Only.dHC.SE.rds")
DREADD_vHC <- readRDS("../data/DREADDTranscriptomics.vHC.SE.rds")
DREADD_dHC <- readRDS("../data/DREADDTranscriptomics.dHC.SE.rds")


DREADD <- cbind(DREADD_vHC[intersect(rownames(DREADD_vHC),rownames(DREADD_dHC)),],DREADD_dHC[intersect(rownames(DREADD_vHC),rownames(DREADD_dHC)),])
DREADD <- dosvacor(DREADD, form = ~Virus + Region, form0 = ~Region)
DREADD <- DREADD[,order(DREADD$Region,DREADD$Virus)]

opto <- cbind(opto_vHC[intersect(rownames(opto_vHC),rownames(opto_dHC)),],opto_dHC[intersect(rownames(opto_vHC),rownames(opto_dHC)),])
opto <- dosvacor(opto, form = ~Condition2 + Region, form0 = ~Region)
opto <- opto[,order(opto$Region,opto$TimePoint,opto$Virus)]

mincount <- 30
Results <- list()
```

## Figure 2B DREADD Volcanos

```{r}
DREADD_vHC <- dosvacor(DREADD_vHC, form = ~Virus)
DREADD_dHC <- dosvacor(DREADD_dHC, form = ~Virus)

y <- DGEList(counts=assays(DREADD_vHC)$counts,group = DREADD_vHC$Virus)
y <- calcNormFactors(y)
y <- estimateDisp(y)
y <- y[filterByExpr(y,group = DREADD_vHC$Virus, min.count = mincount),]
Results[["DREADD_vHC"]] <- exactTest(y)

y <- DGEList(counts=assays(DREADD_dHC)$counts,group = DREADD_dHC$Virus)
y <- calcNormFactors(y)
y <- estimateDisp(y)
y <- y[filterByExpr(y,group = DREADD_dHC$Virus, min.count = mincount),]
Results[["DREADD_dHC"]] <- exactTest(y)

sig_DREADD_vHC <- rownames(topTags(Results[["DREADD_vHC"]], n = Inf, p.value = 0.05))
sig_DREADD_dHC <- rownames(topTags(Results[["DREADD_dHC"]], n = Inf, p.value = 0.05))

Fig2B <- VolcanoPlotsEdgeR(Results[c("DREADD_vHC","DREADD_dHC")],limits = c(-2,2), lab = union(sig_DREADD_vHC,sig_DREADD_dHC))
```


## Figure 2H opto Volcanos

```{r}
opto_vHC <- dosvacor(opto_vHC, form = ~Condition2)
opto_dHC <- dosvacor(opto_dHC, form = ~Condition2)

opto_vHC_45min <- opto_vHC[,opto_vHC$TimePoint == "45min"]
opto_vHC_90min <- opto_vHC[,opto_vHC$TimePoint == "1h30min"]

y <- DGEList(counts=assays(opto_vHC_45min)$counts,group = opto_vHC_45min$Virus)
y <- calcNormFactors(y)
y <- estimateDisp(y)
y <- y[filterByExpr(y,group = opto_vHC_45min$Virus, min.count = mincount),]
Results[["opto_vHC_45min"]] <- exactTest(y)

y <- DGEList(counts=assays(opto_vHC_90min)$counts,group = opto_vHC_90min$Virus)
y <- calcNormFactors(y)
y <- estimateDisp(y)
y <- y[filterByExpr(y,group = opto_vHC_90min$Virus, min.count = mincount),]
Results[["opto_vHC_1h30min"]] <- exactTest(y)


opto_dHC_45min <- opto_dHC[,opto_dHC$TimePoint == "45min"]
opto_dHC_90min <- opto_dHC[,opto_dHC$TimePoint == "1h30min"]

y <- DGEList(counts=assays(opto_dHC_45min)$counts,group = opto_dHC_45min$Virus)
y <- calcNormFactors(y)
y <- estimateDisp(y)
y <- y[filterByExpr(y,group = opto_dHC_45min$Virus, min.count = mincount),]
Results[["opto_dHC_45min"]] <- exactTest(y)

y <- DGEList(counts=assays(opto_dHC_90min)$counts,group = opto_dHC_90min$Virus)
y <- calcNormFactors(y)
y <- estimateDisp(y)
y <- y[filterByExpr(y,group = opto_dHC_90min$Virus, min.count = mincount),]
Results[["opto_dHC_1h30min"]] <- exactTest(y)


sig_opto_vHC_45min <- rownames(topTags(Results[["opto_vHC_45min"]], n = Inf, p.value = 0.05))
sig_opto_vHC_90min <- rownames(topTags(Results[["opto_vHC_1h30min"]], n = Inf, p.value = 0.05))

Fig2H <- VolcanoPlotsEdgeR(Results[c("opto_vHC_45min","opto_vHC_1h30min")], lab = union(sig_opto_vHC_45min,sig_opto_vHC_90min))

```


## Aggregate across datasets (Fig S2X)

Here we do the following to detect genes that are responsive across datasets:
we see which position (by significane) a gene is in a given analysis (1st, 2nd, 3rd etc)
we then sum up all these positions across the relevant analyses
this gives us a ranking of genes by NA responsiveness

```{r}
Results2 <- readRDS("Results.Rds")

datasets <- c("STR2v_StressvsPropr","STR2d_StressvsPropr","STR3_InteractionPropranolol","DREADD_vHC","DREADD_dHC","opto_vHC_45min")

#Create pvalue data frame across the selected analyses
pvals <- data.frame(Results2[[datasets[1]]]$table[,"PValue"])
rownames(pvals) <- rownames(Results2[[datasets[1]]]$table)
pvals$gene <- rownames(pvals)
for(i in datasets[-1]){
  targets <- intersect(rownames(pvals),rownames(Results2[[i]]$table))
  pvals <- pvals[targets,]
  pvals <- cbind(pvals,Results2[[i]]$table[targets,"PValue"])
}

pvals <- na.omit(pvals)
pvals$gene <- NULL

#get order of each gene in each dataset based on pvalue
ord <- apply(pvals,MARGIN = 2, FUN = function(x){
  o <- order(x)
  r <- 1:length(x)
  return(r[order(o)])
})
rownames(ord) <- rownames(pvals)
ord <- apply(ord, MARGIN = 1, FUN = sum)

#Top 20 genes
head(ord[order(ord)],20)

#create plot of top n genes
n <- 4
t <- names(ord[order(ord)][1:n])

STR2 <- readRDS("../final_data/STR2_Complete.SE.Rds")
STR3 <- readRDS("../final_data/STR3_Complete.SE.Rds")

pSTR2 <-meltSE(STR2,t)
p1 <- ggplot(pSTR2,aes(Condition2, corrected, color = Condition)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitterdodge()) + 
  facet_grid(feature~Region, scales = "free") + 
  theme_bw() + theme(legend.position="bottom") + 
  ylab("relative expression") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

pSTR3 <-meltSE(STR3,t)
p2 <- ggplot(pSTR3,aes(Injection, corrected, color = Condition)) +
  geom_boxplot(outlier.shape = NA) + geom_point(position = position_jitterdodge()) + 
  facet_grid(feature~Region, scales = "free") + 
  theme_bw()  + 
  theme(legend.position="bottom") + 
  ylab("relative expression") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

popto <- meltSE(opto_vHC,t)
popto$TimePoint <- factor(popto$TimePoint, levels = c("45min","1h30min"))
p3 <- ggplot(popto,aes(TimePoint, corrected, color = Virus)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitterdodge()) + 
  facet_grid(feature~Region, scales = "free") + 
  theme_bw()  + theme(legend.position="bottom") + 
  ylab("relative expression")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

pDREADD <- meltSE(DREADD,t)
p4 <- ggplot(pDREADD,aes(Virus, corrected, color = Virus)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitterdodge()) + 
  facet_grid(feature~Region, scales = "free") + 
  theme_bw()  + theme(legend.position="bottom") + 
  ylab("relative expression")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

FigS2X <- plot_grid(p1,p2,p3,p4,nrow = 1,rel_widths = c(1,0.7,0.5,0.7))

```


## Show Final Figures

```{r, fig.height= 4, fig.width=6}
print(Fig2B)
```

```{r, fig.height= 4, fig.width=6}
print(Fig2H)
```

```{r, fig.height= 8, fig.width=10}
print(FigS2X)
```


## Export Figures

```{r}
pdf(file = "../Figures/Fig2B.pdf", width = 6, height = 4)
print(Fig2B)
dev.off()

pdf(file = "../Figures/Fig2H.pdf", width = 6, height = 4)
print(Fig2H)
dev.off()

pdf(file = "../Figures/FigS2X.pdf", width = 10, height = 8)
print(FigS2X)
dev.off()

```


## Create final data frames (containing corrected expression and Results data as single SE file)

```{r}
rowData(opto_vHC)[["opto_vHC_45min"]] <- Results$opto_vHC_45min$table[rownames(opto_vHC),]
rowData(opto_vHC)[["opto_vHC_1h30min"]] <- Results$opto_vHC_1h30min$table[rownames(opto_vHC),]

saveRDS(opto_vHC, "../final_data/Opto_Complete.Rds")

rowData(DREADD)[["DREADD_vHC"]] <- Results$DREADD_vHC$table[rownames(DREADD),]
rowData(DREADD)[["DREADD_vHC"]] <- Results$DREADD_dHC$table[rownames(DREADD),]
saveRDS(DREADD, "../final_data/DREADD_Complete.Rds")
```